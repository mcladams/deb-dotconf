#! /usr/bin/env bash

set -e

# Remove all i386 packages from multilib system (optional)
function rm_i386() {
    if [[ ! $(dpkg --print-foreign-architectures) = *i386* ]]; then
        echo "i386 is not a dkpg foreign architecture, nothing to do"
        return
    else
        local pkgs=$( apt list | grep ' i386 ' | grep -E -e '^[^/]*')
        sudo apt purge --allow-remove-essential $(echo "$pkgs" | sed -E 's/^(.*)$/\1:i386/g')
    fi
    sudo dpkg --remove-architecture i386
}

# only apt update if it has not been run in the 10 minutes
function apt-update() {
    if [ $(( `date +%s` - `stat -c %Y /var/cache/apt/pkgcache.bin` )) -gt 600 ]; then
        sudo apt update && sudo apt upgrade -y
    fi
    sudo apt upgrade -y
}

# Install dependencies not already installed, checking when last apt update
# https://unix.stackexchange.com/questions/235605/check-if-all-listed-packages-are-installed-in-bash
function inst_pkgs() {
    local pkgs="$@"
    # apt list returns a line for each architecture if foreign architectures
    # so filter by our architecture or all to remove
    local newpkgs=$(apt list $pkgs | grep -e " $(dpkg --print-architecture)" -e ' all' \
        | grep -e 'installed' -e 'upgradable' -v | grep -E -e '^[^/]*' -o)
    [ -z "$newpkgs" ] || sudo apt install -y $newpkgs
}

# Install deb-get (by script via curl) to install DEBs from git repos & direct dl
# https://github.com/wimpysworld/deb-get
function inst_debget() {
    local depends="curl lsb-release wget"
    inst_pkgs $depends
    curl -sL https://raw.githubusercontent.com/wimpysworld/deb-get/main/deb-get \
        | sudo -E bash -s install deb-get
}

# Install makedeb from script - will add repo to sources
# Ref: https://docs.makedeb.org/installing/shell-script/
function inst_makedeb() {
    local depends="apt binutils build-essential curl fakeroot file gettext gawk \
        libarchive-tools lsb-release python3 python3-apt zstd"
    inst_pkgs $depends
    bash -ci "$(wget -qO - 'https://shlink.makedeb.org/install')"
}

# Install gitub CLI and setup git for authentication using it
# Ref: https://github.com/cli/cli/blob/trunk/docs/install_linux.md
function inst_gh {
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [ arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg ] https://cli.github.com/packages stable main" \
        | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt-get update -o Dir::Etc::sourcelist="sources.list.d/github-cli.list"
    sudo apt install gh -y
    gh auth setup-git
    gh config set editor nano
    gh config set git_protocol https --host github.com
    gh auth login --protocol https --hostname github.com --web
}

# Install latest Neovim from github using makedeb
function inst_neovim() {
    local depends="cmake cmake-data doxygen libclang-cpp14 libclang1-14 libjsoncpp25 \
        libllvm14 librhash0 libtool-bin ninja-build"
    inst_pkgs $depends
    mkdir -p /usr/local/git/org.makedeb.mpr
    cd /usr/local/git/org.makedeb.mpr
    git clone https://mpr.makedeb.org/neovim
    cd neovim
    makedeb -si
}

# Install rust via standard rustup script with profile
function inst_rust() {
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
}

# Install wezterm
#function
# requires http://ftp.debian.org/debian/pool/main/o/openssl/libssl1.1_1.1.1w-0~deb11u1_amd64.deb
# from https://github.com/wez/wezterm/releases/latest

# Apply functions as necessary
type -p deb-get || (echo "Installing deb-get from github deb-get.." && inst_debget)
type -p gh >/dev/null || (echo "Installing gh from githuibcli-archive..." && inst_gh)
type -p makedeb >/dev/null || (echo "Installing makedeb with deb-get..." && inst_makedeb)
type -p nvim >/dev/null || (echo "Installing neovim..." && inst_neovim )
type -p rustc >/dev/null || (echo "Installing rustup script for cargo, rustc, etc..." && inst_rust)
#type -p wezterm
